# PyQt 上位机软件开发文档

## 项目概述

本项目旨在开发一个基于PyQt的上位机软件，用于接收和显示来自嵌入式系统的八路信号数据。软件使用JustFloat数据引擎解析串口接收到的数据，并在界面上以八个独立的图表显示每个通道的电压值，并实时更新电压数值。

## 界面设计

### 主界面布局

主界面采用水平布局，分为左侧控制面板和右侧数据显示区。

1. **顶部菜单栏**：
   - 包含“文件”菜单项。
   - “文件”菜单项中包含“退出”动作。
   - 已移除“设置”和“帮助”菜单。

2. **左侧控制面板**：
   - 包含实时电压显示区域，显示八个通道的当前电压值。
   - 包含协议与连接区域，用于选择数据引擎和数据接口。
   - 包含串口参数配置区域，用于设置端口号、波特率、数据流控、校验位、数据位数和停止位数。
   - 包含操作按钮区域，提供“连接”、“断开”、“生成测试数据”、“复位图表”、“清空数据”和“导出数据”按钮。

3. **右侧数据显示区**：
   - 包含八个独立的图表，采用4行2列的网格布局。
   - 每个图表显示一个通道的电压值，使用PyQtGraph库实现。
   - 图表显示电压范围为0-3.3V，禁用Y轴缩放。
   - X轴（时间）在所有图表间同步。
   - 仅底部图表显示X轴标签。
   - 图表支持鼠标悬停显示数据点信息。

4. **底部状态栏**：
   - 显示串口连接状态和其他相关信息。

### 界面元素

- **实时电压标签**：八个标签，分别显示CH1到CH8的实时电压值。
- **数据引擎下拉框**：提供数据引擎选项（当前为“JustFloat”）。
- **数据接口下拉框**：提供数据接口选项（当前为“串口”）。
- **端口号下拉框**：列出可用的串口。
- **波特率下拉框**：提供常见的波特率选项（如9600, 115200等）。
- **数据流控下拉框**：提供流控选项（None, RTS/CTS, XON/XOFF）。
- **校验位下拉框**：提供校验位选项（None, Even, Odd, Mark, Space）。
- **数据位数下拉框**：提供数据位数选项（5, 6, 7, 8）。
- **停止位数下拉框**：提供停止位数选项（1, 1.5, 2）。
- **连接按钮**：用于控制串口连接状态。
- **断开按钮**：用于控制串口连接状态。
- **生成测试数据按钮**：用于启动/停止生成模拟测试数据。
- **复位图表按钮**：用于重置图表的视图范围。
- **清空数据按钮**：用于清除图表上已显示的数据。
- **导出数据按钮**：用于将采集到的数据导出到CSV文件。
- **八个图表**：每个图表显示一个通道的电压值，使用PyQtGraph库实现。

## 数据处理

### 数据接收

- 使用`pyserial`库在独立的线程中接收串口数据。
- 串口参数（端口、波特率、数据位、停止位、校验位、流控）通过界面配置。

### 数据解析

- 使用JustFloat数据引擎解析接收到的数据。
- 每次接收到的数据包含八个浮点数，每个浮点数占用4字节。
- 数据帧尾为`{0x00, 0x00, 0x80, 0x7f}`。
- 缓冲区机制处理不完整的数据帧。

### 数据显示

- 将解析后的浮点数直接作为电压值进行处理。
- 在对应的图表上实时更新显示电压值。
- 实时电压值也更新到左侧面板的标签上。
- 图表最多显示最近的200个数据点。

## 功能实现

### 串口通信

- 使用`pyserial`库在独立的`SerialThread`中实现串口通信。
- “连接”按钮点击时，根据界面选择的参数启动`SerialThread`。
- “断开”按钮点击时，停止`SerialThread`并关闭串口。
- 串口状态变化通过信号更新到主界面状态栏。

### 图表显示

- 使用`PyQtGraph`库绘制八个独立的图表。
- 每个图表显示一个通道的电压-时间曲线。
- 接收到新数据时，更新对应通道的数据队列和图表。
- 图表X轴（时间）范围自动调整以显示最新数据。
- 实现图表X轴范围的同步联动。
- 实现鼠标悬停在图表上显示对应数据点的时间和电压值。

### 状态更新

- 在底部状态栏显示串口连接状态和错误信息。
- 实时更新左侧面板的电压值标签。

### 数据导出

- “导出数据”按钮点击时，打开文件保存对话框。
- 将所有通道的历史数据导出到用户指定的CSV文件。

### 测试数据生成

- “生成测试数据”按钮用于启动或停止一个定时器，模拟生成随机数据并更新图表，用于无硬件时的功能演示和调试。

## 开发步骤

1. **环境搭建**：
   - 安装Python和必要的库（PyQt5, pyserial, PyQtGraph）。
   
2. **界面设计**：
   - 使用PyQt5代码直接构建主界面，包括左侧控制面板和右侧图表区域。
   - 布局控件，设置字体、颜色、间距等样式。

3. **功能实现**：
   - 实现`SerialThread`类处理串口通信和数据解析。
   - 实现主窗口类`MainWindow`，管理界面元素和数据处理逻辑。
   - 连接信号和槽，实现按钮点击、数据接收、状态更新等交互。
   - 实现图表数据更新、X轴同步、悬停信息显示等功能。
   - 实现数据导出功能。
   - 实现测试数据生成功能。

4. **测试与优化**：
   - 测试软件的串口通信、数据解析、图表显示、数据导出和测试数据生成等功能。
   - 根据测试结果进行优化，提高性能和稳定性。

## 结论

本开发文档详细描述了基于PyQt的上位机软件的设计和实现过程。通过合理的界面布局和功能实现，软件能够有效地接收和显示来自嵌入式系统的八路信号数据，并提供数据导出和测试数据生成等辅助功能。